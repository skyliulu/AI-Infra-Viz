import{c as f,r as g,R as I,j as e,Z as T,C as Q}from"./index-CW0iHl68.js";import{R as U,P as Z,a as J,S as Y,C as ee,D as se}from"./skip-forward-DWpR5prq.js";/**
 * @license lucide-react v0.400.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const te=f("AlignLeft",[["line",{x1:"21",x2:"3",y1:"6",y2:"6",key:"1fp77t"}],["line",{x1:"15",x2:"3",y1:"12",y2:"12",key:"v6grx8"}],["line",{x1:"17",x2:"3",y1:"18",y2:"18",key:"1awlsn"}]]);/**
 * @license lucide-react v0.400.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const z=f("ArrowDown",[["path",{d:"M12 5v14",key:"s699le"}],["path",{d:"m19 12-7 7-7-7",key:"1idqje"}]]);/**
 * @license lucide-react v0.400.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const R=f("CornerDownRight",[["polyline",{points:"15 10 20 15 15 20",key:"1q7qjw"}],["path",{d:"M4 4v7a4 4 0 0 0 4 4h12",key:"z08zvw"}]]);/**
 * @license lucide-react v0.400.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const C=f("Network",[["rect",{x:"16",y:"16",width:"6",height:"6",rx:"1",key:"4q2zg0"}],["rect",{x:"2",y:"16",width:"6",height:"6",rx:"1",key:"8cvhb9"}],["rect",{x:"9",y:"2",width:"6",height:"6",rx:"1",key:"1egb70"}],["path",{d:"M5 16v-3a1 1 0 0 1 1-1h12a1 1 0 0 1 1 1v3",key:"1jsf9p"}],["path",{d:"M12 12V8",key:"2874zd"}]]);/**
 * @license lucide-react v0.400.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const A=f("Orbit",[["circle",{cx:"12",cy:"12",r:"3",key:"1v7zrd"}],["circle",{cx:"19",cy:"5",r:"2",key:"mhkx31"}],["circle",{cx:"5",cy:"19",r:"2",key:"v8kfzx"}],["path",{d:"M10.4 21.9a10 10 0 0 0 9.941-15.416",key:"eohfx2"}],["path",{d:"M13.5 2.1a10 10 0 0 0-9.841 15.416",key:"19pvbm"}]]);/**
 * @license lucide-react v0.400.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const q=f("Repeat",[["path",{d:"m17 2 4 4-4 4",key:"nntrym"}],["path",{d:"M3 11v-1a4 4 0 0 1 4-4h14",key:"84bu3i"}],["path",{d:"m7 22-4-4 4-4",key:"1wqhfi"}],["path",{d:"M21 13v1a4 4 0 0 1-4 4H3",key:"1rx37r"}]]);/**
 * @license lucide-react v0.400.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const D=f("SlidersHorizontal",[["line",{x1:"21",x2:"14",y1:"4",y2:"4",key:"obuewd"}],["line",{x1:"10",x2:"3",y1:"4",y2:"4",key:"1q6298"}],["line",{x1:"21",x2:"12",y1:"12",y2:"12",key:"1iu8h1"}],["line",{x1:"8",x2:"3",y1:"12",y2:"12",key:"ntss68"}],["line",{x1:"21",x2:"16",y1:"20",y2:"20",key:"14d8ph"}],["line",{x1:"12",x2:"3",y1:"20",y2:"20",key:"m0wm8r"}],["line",{x1:"14",x2:"14",y1:"2",y2:"6",key:"14e1ph"}],["line",{x1:"8",x2:"8",y1:"10",y2:"14",key:"1i6ji0"}],["line",{x1:"16",x2:"16",y1:"18",y2:"22",key:"1lctlv"}]]),p=["人工","智能","的","发展","将","会"],u=[{token:"带来",probs:[{t:"带来",p:.85},{t:"导致",p:.1},{t:"让",p:.05}]},{token:"深远",probs:[{t:"深远",p:.72},{t:"巨大",p:.2},{t:"很多",p:.08}]},{token:"的",probs:[{t:"的",p:.99},{t:"地",p:.005},{t:"得",p:.005}]},{token:"变革",probs:[{t:"变革",p:.65},{t:"影响",p:.3},{t:"改变",p:.05}]},{token:"。",probs:[{t:"。",p:.95},{t:"！",p:.03},{t:"？",p:.02}]},{token:"<EOS>",probs:[{t:"<EOS>",p:.99},{t:`
`,p:.01}]}],O=[{topK:[2,5],weights:[.65,.25]},{topK:[1,7],weights:[.55,.35]},{topK:[0,4],weights:[.48,.42]},{topK:[3,6],weights:[.7,.15]},{topK:[2,7],weights:[.6,.38]},{topK:[0,5],weights:[.5,.45]}],N=32,ie=()=>{const[n,W]=g.useState("moe"),[b,V]=g.useState(1),[_,v]=g.useState(1),[t,y]=g.useState("idle"),[r,w]=g.useState(0),[s,h]=g.useState(0),[j,k]=g.useState(!1);g.useEffect(()=>{let a;if(s===4)_<N?a=setTimeout(()=>v(l=>l+1),30):a=setTimeout(()=>h(5),300);else if(j){let l=1e3;s===6&&(l=1500),s===0&&t==="idle"&&(l=500),s===1.5&&(l=1200),s===3&&n==="moe"&&(l=1500),a=setTimeout(()=>F(),l)}return()=>clearTimeout(a)},[j,t,s,r,n,_]);const F=()=>{t==="idle"?(y("prefill"),w(0),h(1),v(1)):t==="done"||s===4||(s<6?h(s===1?1.5:s===1.5?2:s+1):t==="prefill"?(y("decode"),w(1),h(1),v(1)):t==="decode"&&(r+1<u.length?(w(r+1),h(1),v(1)):(y("done"),h(0),k(!1))))},E=()=>{k(!1),y("idle"),w(0),h(0),v(1)},H=()=>{t==="done"&&E(),k(!j)},L=a=>{a!==n&&(W(a),E())},$=s>=5?u[r].probs:null,P=I.useMemo(()=>{if(!$)return null;if(b===1)return $;const a=$.map(i=>({...i,weight:Math.pow(i.p,1/b)})),l=a.reduce((i,m)=>i+m.weight,0);return a.map(i=>({t:i.t,p:i.weight/l}))},[$,b]),M=t==="idle"?0:t==="prefill"?s>=2?p.length:0:p.length+r-1+(s>=2?1:0),X=()=>t==="idle"?"开始计算 (Prefill)":s===1?"注入位置编码(RoPE)":s===1.5?"进入 Attention":s===2?n==="moe"?"进入 MoE":"进入 FFN":s===3?`循环计算 ${N} 层`:s===4?"光速堆叠中...":s===5?"输出概率 (可调温)":s===6?t==="prefill"?"进入 Decode 阶段":"预测下一 Token":"已完成",K=(a,l)=>e.jsx("div",{className:"flex flex-wrap gap-2 mb-4",children:a.map((i,m)=>{let c=t==="prefill"&&s===1&&l,d=!1,x=!1,o=!1;if(l)d=t!=="idle"&&!(t==="prefill"&&s<2);else{if(m>r||m===r&&s<5)return null;m<r?(d=!0,t==="decode"&&m===r-1&&s===1&&(o=!0)):m===r&&s>=5&&(d=!0,x=s===5||s===6)}return e.jsxs("div",{className:`px-3 py-2 rounded-lg text-sm font-medium border-2 transition-all duration-300 relative
            ${l?"border-blue-200":"border-green-200"}
            ${c?"scale-110 shadow-lg ring-4 ring-opacity-50 z-10 bg-blue-500 text-white ring-blue-300 border-blue-500":""}
            ${o?"scale-110 bg-indigo-600 text-white ring-4 ring-indigo-300 border-indigo-500 shadow-xl z-20 animate-pulse":""}
            ${x?"scale-105 bg-green-100 border-green-400 text-green-800 ring-2 ring-green-200 shadow-md":""}
            ${d&&!c&&!o&&!x?l?"bg-blue-50 text-blue-800":"bg-green-50 text-green-800":""}
            ${!d&&!c&&!o&&!x?"bg-gray-50 text-gray-400 border-gray-200":""}
          `,children:[o&&e.jsxs("div",{className:"absolute -top-6 left-1/2 transform -translate-x-1/2 text-xs font-bold text-indigo-600 whitespace-nowrap animate-bounce flex items-center gap-1",children:["作为输入 ",e.jsx(R,{size:12})]}),i]},m)})});return e.jsx("div",{className:"min-h-screen bg-slate-50 text-slate-800 font-sans p-4 lg:p-6 selection:bg-indigo-100",children:e.jsxs("div",{className:"max-w-[90rem] mx-auto space-y-6",children:[e.jsxs("div",{className:"bg-white rounded-2xl p-4 lg:p-6 shadow-sm border border-slate-200 flex flex-col md:flex-row items-center justify-between gap-4",children:[e.jsxs("div",{children:[e.jsxs("h1",{className:"text-xl lg:text-2xl font-bold flex items-center gap-2 text-indigo-900",children:[e.jsx(T,{className:"text-amber-500"}),"LLM 推理全景可视化"]}),e.jsx("p",{className:"text-slate-500 text-sm mt-1",children:"完全掌控大模型的底层脉络：看透注意力、稀疏路由、深度循环与采样艺术"})]}),e.jsxs("div",{className:"flex flex-wrap items-center justify-center gap-3",children:[e.jsxs("div",{className:"flex items-center gap-2 bg-purple-50 px-3 py-1.5 rounded-lg border border-purple-200 mr-2",title:"调整生成随机性",children:[e.jsx(D,{size:14,className:"text-purple-600"}),e.jsx("span",{className:"text-xs font-semibold text-purple-800",children:"温度(T):"}),e.jsx("input",{type:"range",min:"0.1",max:"2.0",step:"0.1",value:b,onChange:a=>V(parseFloat(a.target.value)),className:"w-20 accent-purple-500"}),e.jsx("span",{className:"text-xs font-mono font-bold text-purple-700 w-6 text-right",children:b.toFixed(1)})]}),e.jsxs("div",{className:"flex bg-slate-100 p-1 rounded-lg border border-slate-200 mr-2",children:[e.jsx("button",{onClick:()=>L("dense"),className:`flex items-center gap-1.5 px-3 py-1.5 text-xs lg:text-sm font-semibold rounded-md transition-all ${n==="dense"?"bg-white shadow-sm text-indigo-700":"text-slate-500 hover:text-slate-700"}`,children:"Dense (稠密)"}),e.jsxs("button",{onClick:()=>L("moe"),className:`flex items-center gap-1.5 px-3 py-1.5 text-xs lg:text-sm font-semibold rounded-md transition-all ${n==="moe"?"bg-white shadow-sm text-indigo-700":"text-slate-500 hover:text-slate-700"}`,children:[e.jsx(C,{size:14})," MoE (稀疏)"]})]}),e.jsx("button",{onClick:E,className:"p-2 rounded-lg bg-slate-100 text-slate-600 hover:bg-slate-200 transition",title:"重置",children:e.jsx(U,{size:20})}),e.jsx("button",{onClick:H,className:`flex items-center gap-2 px-4 py-2 rounded-lg font-medium text-white transition shadow-sm ${j?"bg-rose-500 hover:bg-rose-600":"bg-indigo-600 hover:bg-indigo-700"}`,children:j?e.jsxs(e.Fragment,{children:[e.jsx(Z,{size:18})," 暂停"]}):e.jsxs(e.Fragment,{children:[e.jsx(J,{size:18})," ",t==="done"?"重播":"自动播放"]})}),e.jsxs("button",{onClick:()=>{k(!1),F()},disabled:j||t==="done"||s===4,className:"flex items-center gap-2 px-4 py-2 w-48 justify-center rounded-lg bg-white border border-slate-300 text-slate-700 hover:bg-indigo-50 hover:text-indigo-700 hover:border-indigo-300 disabled:opacity-50 transition shadow-sm font-semibold",children:[e.jsx(Y,{size:18})," ",e.jsx("span",{className:"text-sm",children:X()})]})]})]}),e.jsxs("div",{className:"grid grid-cols-1 lg:grid-cols-3 gap-6",children:[e.jsxs("div",{className:"col-span-1 lg:col-span-2 space-y-6",children:[e.jsxs("div",{className:"bg-white rounded-2xl p-6 shadow-sm border border-slate-200 relative overflow-hidden",children:[e.jsxs("h2",{className:"text-lg font-semibold mb-4 flex items-center gap-2",children:[e.jsx(te,{className:"text-indigo-500",size:20}),"序列 (Sequence) - 观察自回归回路"]}),e.jsx("div",{className:"mb-2 text-sm text-slate-500 font-medium",children:"Prompt (输入提示词):"}),K(p,!0),e.jsx("div",{className:"mt-8 mb-2 text-sm text-slate-500 font-medium",children:"Generation (模型生成):"}),e.jsx("div",{className:"min-h-[60px]",children:K(u.map(a=>a.token),!1)})]}),e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-6 items-stretch",children:[e.jsxs("div",{className:"bg-white rounded-2xl p-6 shadow-sm border border-slate-200 h-full flex flex-col min-w-0",children:[e.jsxs("h2",{className:"text-lg font-semibold mb-6 flex items-center justify-between shrink-0",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(Q,{className:"text-indigo-500",size:20})," 模型内部流水线"]}),e.jsx("span",{className:`text-xs px-2 py-1 rounded-full font-mono ${n==="moe"?"bg-teal-100 text-teal-800 border border-teal-200":"bg-slate-100 text-slate-600 border border-slate-200"}`,children:n==="moe"?"MoE Architecture":"Dense Architecture"})]}),e.jsxs("div",{className:"relative p-4 md:p-6 border-2 border-dashed border-indigo-200 rounded-xl bg-indigo-50/30 flex-1 overflow-x-auto",children:[e.jsx("div",{className:"absolute top-4 left-4 z-10 flex flex-col gap-2",children:e.jsx("span",{className:`inline-flex items-center gap-1.5 px-3 py-1 rounded-full text-[10px] md:text-xs font-bold uppercase tracking-wider transition-all
                      ${t==="prefill"?"bg-amber-100 text-amber-700 ring-2 ring-amber-400 scale-105":"bg-slate-100 text-slate-400"}`,children:"Prefill"})}),e.jsx("div",{className:"absolute top-4 right-4 z-10",children:e.jsx("span",{className:`inline-flex items-center gap-1.5 px-3 py-1 rounded-full text-[10px] md:text-xs font-bold uppercase tracking-wider transition-all
                      ${t==="decode"?"bg-emerald-100 text-emerald-700 ring-2 ring-emerald-400 scale-105":"bg-slate-100 text-slate-400"}`,children:"Decode"})}),e.jsxs("div",{className:`mx-auto w-full max-w-sm mt-10 md:mt-12 rounded-xl p-3 md:p-4 flex flex-col relative transition-all duration-500 shadow-xl border bg-white
                    ${t==="prefill"?"border-amber-300 ring-4 ring-amber-400/20":t==="decode"?"border-emerald-300 ring-4 ring-emerald-400/20":"border-slate-200"}`,children:[e.jsxs("div",{className:"text-center mb-4 h-8 flex items-center justify-center",children:[t==="prefill"&&s>0&&e.jsx("span",{className:"text-xs md:text-sm font-bold text-amber-600 bg-amber-50 px-3 py-1 rounded-full border border-amber-200 animate-fade-in",children:"当前输入: [完整 Prompt - 6 个 Token]"}),t==="decode"&&s>0&&r>0&&e.jsxs("span",{className:"text-xs md:text-sm font-bold text-indigo-700 bg-indigo-50 px-3 py-1 rounded-full border border-indigo-200 flex items-center gap-2 animate-fade-in",children:[e.jsx(R,{size:14}),' 自回归输入: "',u[r-1].token,'"']})]}),e.jsx("div",{className:"relative z-10 flex flex-col",children:(()=>{const a=t==="idle"?"?":t==="prefill"?p.length:1,l=t==="idle"?"?":t==="prefill"?p.length:p.length+r,i="d",m="V",c=t==="prefill"?"text-amber-600":t==="decode"?"text-emerald-600":"text-slate-400",d=O[Math.min(r,O.length-1)];return e.jsxs(e.Fragment,{children:[e.jsxs("div",{className:`p-2 rounded border transition-all duration-300 shadow-sm ${s===1?"bg-indigo-50 border-indigo-400 ring-2 ring-indigo-200 scale-105 z-10":"bg-slate-50 border-slate-200 opacity-60"}`,children:[e.jsx("div",{className:`font-semibold text-xs md:text-sm text-center ${s===1?"text-indigo-900":"text-slate-500"}`,children:"Input Embedding"}),e.jsx("div",{className:"mt-2 text-[10px] md:text-xs font-mono bg-white p-1.5 rounded border border-indigo-100 flex flex-col gap-1",children:e.jsxs("div",{className:"flex justify-between px-1",children:[e.jsxs("span",{className:"font-serif tracking-wide text-[11px] md:text-[13px]",children:["Output (",e.jsx("span",{className:"italic",children:"X"}),") :"]}),e.jsxs("span",{className:`${c} font-bold text-xs bg-slate-100 px-1 rounded`,children:["[",a,", ",i,"]"]})]})})]}),e.jsx("div",{className:"flex justify-center -my-1 relative z-0",children:e.jsx(z,{className:`${s===1||s===1.5?"text-indigo-400 animate-bounce":"text-slate-200"}`,size:16})}),e.jsxs("div",{className:`p-2 rounded border transition-all duration-300 shadow-sm ${s===1.5?"bg-fuchsia-50 border-fuchsia-400 ring-2 ring-fuchsia-200 scale-105 z-10":"bg-slate-50 border-slate-200 opacity-60"}`,children:[e.jsxs("div",{className:`font-semibold text-xs md:text-sm text-center flex items-center justify-center gap-1 ${s===1.5?"text-fuchsia-900":"text-slate-500"}`,children:[e.jsx(A,{size:14,className:s===1.5?"animate-spin":""})," RoPE 旋转位置编码"]}),e.jsxs("div",{className:"mt-1 text-[10px] md:text-xs font-mono bg-white p-1.5 rounded border border-fuchsia-100 flex flex-col gap-1.5",children:[e.jsx("div",{className:"text-center text-fuchsia-700 font-semibold mb-1 opacity-80 border-b border-fuchsia-100 pb-1",children:t==="idle"?"等待输入序列...":t==="prefill"?"依据绝对位置 m 进行多维旋转":`当前生成词绝对位置: m=${p.length+r}`}),e.jsx("div",{className:"flex justify-between items-center bg-fuchsia-50 -mx-1 px-2 py-0.5 rounded border border-fuchsia-100",children:e.jsxs("span",{className:"font-serif text-[11px] md:text-[13px] tracking-wide",children:[e.jsx("span",{className:"italic",children:"X"}),e.jsx("sub",{className:"not-italic",children:"rope"})," = ",e.jsx("span",{className:"italic",children:"X"})," · cos(",e.jsx("span",{className:"italic",children:"mθ"}),") + ",e.jsx("span",{className:"italic",children:"X'"})," · sin(",e.jsx("span",{className:"italic",children:"mθ"}),")"]})})]})]}),e.jsx("div",{className:"flex justify-center -my-1 relative z-0",children:e.jsx(z,{className:`${s===1.5?"text-fuchsia-400 animate-bounce":"text-slate-200"}`,size:16})}),e.jsxs("div",{className:`border-2 rounded-xl p-2 relative transition-all duration-300 mt-2 mb-2 
                              ${s===4?"border-amber-400 bg-amber-50/50 ring-4 ring-amber-200/50 scale-105 z-20 shadow-xl":"border-slate-200 border-dashed"}`,children:[e.jsxs("div",{className:"absolute -left-2 -top-3 bg-white px-2 text-[10px] font-bold text-slate-500 flex items-center gap-1 rounded border border-slate-200",children:[e.jsx(q,{size:12,className:s===4?"animate-spin text-amber-500":""}),"Transformer Block (×",N," Layers)"]}),s===4&&e.jsxs("div",{className:"absolute right-2 -top-4 bg-amber-500 text-white px-3 py-0.5 rounded-full text-[11px] font-bold shadow-lg animate-pulse flex items-center gap-1",children:[e.jsx(T,{size:12})," Looping Layer: ",_," / ",N]}),e.jsxs("div",{className:`mt-3 p-2 rounded border transition-all duration-300 shadow-sm ${s===2||s===4?"bg-blue-50 border-blue-400 ring-1 ring-blue-200":"bg-slate-50 border-slate-200 opacity-60"} ${s===2?"scale-105 z-10 shadow-lg":""}`,children:[e.jsx("div",{className:`font-semibold text-xs md:text-sm mb-2 text-center ${s===2||s===4?"text-blue-900":"text-slate-500"}`,children:"Masked Self-Attention"}),e.jsxs("div",{className:"text-[10px] md:text-xs font-mono bg-white p-1.5 rounded border border-blue-100 flex flex-col gap-1.5",children:[e.jsxs("div",{className:"flex justify-between px-1",children:[e.jsxs("span",{className:"font-serif text-[11px] md:text-[13px] tracking-wide",children:[e.jsx("span",{className:"italic",children:"Q, K, V"})," = ",e.jsx("span",{className:"italic",children:"XW"}),e.jsx("sub",{className:"not-italic",children:"q,k,v"})," :"]}),e.jsxs("span",{className:`${c} font-bold text-xs bg-slate-100 px-1 rounded`,children:["[",a,", ",i,"]"]})]}),e.jsxs("div",{className:`flex justify-between items-center px-1 md:px-2 py-0.5 rounded border -mx-1 ${s===2||s===4?"bg-pink-50 border-pink-200":"border-transparent"}`,children:[e.jsxs("span",{className:`font-serif text-[11px] md:text-[13px] tracking-wide ${s===2||s===4?"text-pink-900":"text-slate-600"}`,children:[e.jsx("span",{className:"italic",children:"Scores"})," = ",e.jsx("span",{className:"italic",children:"QK"}),e.jsx("sup",{className:"not-italic",children:"T"})," :"]}),e.jsxs("span",{className:"text-slate-600 font-bold text-xs",children:["[",a,", ",e.jsx("span",{className:`${s===2||s===4?"bg-pink-200 text-pink-800":"bg-slate-100 text-slate-600"} px-1 rounded transition-all`,children:l}),"]"]})]}),e.jsxs("div",{className:"flex justify-between px-1",children:[e.jsxs("span",{className:"font-serif text-[11px] md:text-[13px] tracking-wide",children:[e.jsx("span",{className:"italic",children:"Attn_out"})," = Softmax(",e.jsx("span",{className:"italic",children:"Scores"}),")",e.jsx("span",{className:"italic",children:"V"})," :"]}),e.jsxs("span",{className:`${c} font-bold text-xs bg-slate-100 px-1 rounded`,children:["[",a,", ",i,"]"]})]})]})]}),e.jsx("div",{className:"flex justify-center -my-1 relative z-0",children:e.jsx(z,{className:`${s===2||s===4?"text-blue-400":"text-slate-200"}`,size:16})}),n==="dense"?e.jsxs("div",{className:`p-2 rounded border transition-all duration-300 shadow-sm ${s===3||s===4?"bg-indigo-50 border-indigo-400 ring-1 ring-indigo-200":"bg-slate-50 border-slate-200 opacity-60"} ${s===3?"scale-105 z-10 shadow-lg":""}`,children:[e.jsx("div",{className:`font-semibold text-xs md:text-sm text-center ${s===3||s===4?"text-indigo-900":"text-slate-500"}`,children:"Dense Feed Forward (MLP)"}),e.jsxs("div",{className:"mt-1 text-[10px] md:text-xs font-mono bg-white p-1.5 rounded border border-indigo-100 flex flex-col gap-1.5",children:[e.jsxs("div",{className:"flex justify-between items-center bg-indigo-50 -mx-1 px-2 py-0.5 rounded border border-indigo-100",children:[e.jsxs("span",{className:"font-serif text-[11px] md:text-[13px] tracking-wide",children:[e.jsx("span",{className:"italic",children:"H"})," = GELU(",e.jsx("span",{className:"italic",children:"XW"}),e.jsx("sub",{className:"not-italic",children:"up"}),") :"]}),e.jsxs("span",{className:`${c} font-bold text-xs bg-slate-100 px-1 rounded`,children:["[",a,", ",e.jsx("span",{className:"text-indigo-600",children:"4d"}),"]"]})]}),e.jsxs("div",{className:"flex justify-between px-1",children:[e.jsxs("span",{className:"font-serif text-[11px] md:text-[13px] tracking-wide",children:[e.jsx("span",{className:"italic",children:"Out"})," = ",e.jsx("span",{className:"italic",children:"HW"}),e.jsx("sub",{className:"not-italic",children:"down"})," :"]}),e.jsxs("span",{className:`${c} font-bold text-xs bg-slate-100 px-1 rounded`,children:["[",a,", ",i,"]"]})]})]})]}):e.jsxs("div",{className:`p-2 rounded border transition-all duration-300 shadow-sm ${s===3||s===4?"bg-teal-50 border-teal-400 ring-1 ring-teal-200":"bg-slate-50 border-slate-200 opacity-60"} ${s===3?"scale-105 z-10 shadow-lg":""}`,children:[e.jsxs("div",{className:`font-semibold text-xs md:text-sm text-center flex items-center justify-center gap-1 ${s===3||s===4?"text-teal-900":"text-slate-500"}`,children:[e.jsx(C,{size:14})," Sparse MoE Layer"]}),e.jsxs("div",{className:"mt-1 text-[10px] md:text-xs font-mono bg-white p-1 md:p-1.5 rounded border border-teal-100 flex flex-col gap-1.5",children:[e.jsxs("div",{className:"flex justify-between px-1 opacity-60",children:[e.jsxs("span",{className:"font-serif text-[11px] md:text-[13px] tracking-wide",children:["Router 矩阵 ",e.jsx("span",{className:"italic",children:"W"}),e.jsx("sub",{className:"not-italic",children:"g"}),":"]}),e.jsxs("span",{children:["[",i,", ",e.jsx("span",{className:"text-teal-600 font-bold",children:"8"}),"]"]})]}),e.jsx("div",{className:`flex justify-between px-1 rounded transition-colors ${s===3||s===4?"bg-amber-50 text-amber-800 border border-amber-200":""}`,children:e.jsxs("span",{className:"font-serif text-[11px] md:text-[13px] tracking-wide",children:[e.jsx("span",{className:"italic",children:"Scores"})," = Softmax(",e.jsx("span",{className:"italic",children:"XW"}),e.jsx("sub",{className:"not-italic",children:"g"}),")"]})}),e.jsx("div",{className:"flex justify-between items-end gap-0.5 md:gap-1 mt-1 mb-1",children:[0,1,2,3,4,5,6,7].map(x=>{const o=s>=3,G=d.topK.includes(x),S=o&&G,B=S?d.weights[d.topK.indexOf(x)].toFixed(2):o?"0.01":"-";return e.jsxs("div",{className:"flex flex-col items-center justify-end w-full",children:[e.jsx("div",{className:`text-[8px] mb-0.5 transition-all duration-500 ${S?"text-teal-700 font-bold scale-125":"text-slate-300 opacity-50"}`,children:B}),e.jsxs("div",{className:`w-full h-4 md:h-5 rounded border flex items-center justify-center text-[8px] md:text-[10px] transition-all duration-300 ${S?"bg-teal-100 border-teal-400 text-teal-800 font-bold shadow ring-1 ring-teal-300 animate-pulse":"bg-slate-50 border-slate-200 text-slate-400"}`,children:["E",x]})]},x)})}),e.jsxs("div",{className:`flex flex-col bg-teal-50 -mx-1 px-1 md:px-2 py-1 rounded border transition-colors ${s===3||s===4?"border-teal-300":"border-teal-100"}`,children:[e.jsxs("div",{className:"flex justify-between items-center w-full mb-1",children:[e.jsx("span",{className:"text-teal-800 font-semibold",children:"Top-2 融合:"}),e.jsxs("span",{className:`${c} font-bold text-[10px] bg-white px-1 rounded border border-teal-100`,children:["[",a,", ",i,"]"]})]}),e.jsx("div",{className:"text-[10px] md:text-[12px] text-teal-900 text-center tracking-wide font-serif",children:s>=3?e.jsxs(e.Fragment,{children:[e.jsx("span",{className:"italic font-bold",children:"Out"})," = ",d.weights[0].toFixed(2)," · ",e.jsx("span",{className:"italic",children:"E"}),e.jsx("sub",{className:"not-italic",children:d.topK[0]})," + ",d.weights[1].toFixed(2)," · ",e.jsx("span",{className:"italic",children:"E"}),e.jsx("sub",{className:"not-italic",children:d.topK[1]})]}):e.jsx("span",{className:"font-sans font-normal text-[10px]",children:"等待 Router 打分分发..."})})]})]})]})]}),e.jsx("div",{className:"flex justify-center -my-1 relative z-0",children:e.jsx(z,{className:`${s>=4?"text-purple-400 animate-bounce":"text-slate-200"}`,size:16})}),e.jsxs("div",{className:`p-2 md:p-3 rounded border transition-all duration-300 shadow-sm ${s>=5?"bg-purple-50 border-purple-400 ring-2 ring-purple-200 scale-105 z-10":"bg-slate-50 border-slate-200 opacity-60"}`,children:[e.jsxs("div",{className:`font-semibold text-xs md:text-sm text-center mb-2 ${s>=5?"text-purple-900":"text-slate-500"}`,children:["LM Head & 温度采样 (T=",b.toFixed(1),")"]}),e.jsx("div",{className:"text-[10px] md:text-xs font-mono bg-white p-1.5 rounded border border-purple-100 flex flex-col gap-1.5",children:e.jsxs("div",{className:"flex justify-between items-center bg-purple-50 -mx-1 px-2 py-0.5 rounded border border-purple-100",children:[e.jsxs("span",{className:"font-serif text-[11px] md:text-[13px] tracking-wide",children:[e.jsx("span",{className:"italic",children:"Logits"})," = ",e.jsx("span",{className:"italic",children:"XW"}),e.jsx("sub",{className:"not-italic",children:"vocab"})," :"]}),e.jsxs("span",{className:`${c} font-bold text-xs bg-slate-100 px-1 rounded`,children:["[",a,", ",e.jsx("span",{className:"text-purple-600",children:m}),"]"]})]})}),e.jsxs("div",{className:"mt-3 pt-3 border-t border-purple-200",children:[e.jsxs("div",{className:"text-[10px] font-semibold text-purple-600 mb-2 uppercase tracking-wider flex justify-between",children:[e.jsx("span",{children:"采样概率分布 (Softmax)"}),s===6&&e.jsx("span",{className:"text-emerald-600 font-bold animate-pulse",children:"预测完成 ✓"})]}),P?e.jsx("div",{className:"space-y-1.5 animate-fade-in",children:P.map((x,o)=>e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("div",{className:"w-8 md:w-10 text-xs font-medium text-right text-purple-900",children:x.t}),e.jsx("div",{className:"flex-1 h-2.5 bg-purple-100 rounded-full overflow-hidden relative",children:e.jsx("div",{className:`h-full rounded-full transition-all duration-300 ease-out ${o===0?"bg-purple-500":"bg-purple-300"}`,style:{width:`${x.p*100}%`}})}),e.jsxs("div",{className:"w-8 text-[10px] text-purple-600 text-right font-mono",children:[(x.p*100).toFixed(0),"%"]})]},o))}):e.jsx("div",{className:"text-center text-purple-400 text-[10px] italic py-2",children:s>0&&s<5?"等待层循环堆叠完成...":"等待计算..."})]})]})]})})()})]})]})]}),e.jsxs("div",{className:"bg-slate-900 rounded-2xl p-6 shadow-lg border border-slate-800 text-slate-300 h-full flex flex-col min-w-0",children:[e.jsxs("h2",{className:"text-lg font-semibold mb-4 flex items-center justify-between text-white shrink-0",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(ee,{className:"text-emerald-400",size:20})," 底层代码 ",e.jsx("span",{className:"text-xs text-slate-400 font-normal ml-2",children:"(Python 伪代码)"})]}),n==="moe"&&e.jsx("span",{className:"text-xs bg-teal-900/50 text-teal-400 px-2 py-1 rounded border border-teal-800",children:"MoE Enabled"})]}),e.jsx("div",{className:"font-mono text-[10px] md:text-xs xl:text-sm overflow-x-auto bg-[#0d1117] p-4 rounded-lg border border-slate-800 flex-1 leading-relaxed",children:e.jsxs("div",{className:"transition-all duration-500 whitespace-pre block",children:[e.jsxs("div",{children:[e.jsx("span",{className:"text-emerald-400",children:"def"})," ",e.jsx("span",{className:"text-blue-400",children:t==="prefill"?"prefill":"decode"}),"(input_tokens, kv_cache, temp=",b.toFixed(1),"):"]}),e.jsxs("div",{className:s===1?"bg-indigo-900/60 text-indigo-200 px-1 -mx-1 rounded":"text-slate-400",children:[e.jsxs("div",{children:["  ",e.jsx("span",{className:"text-slate-500",children:"# Embedding"})]}),e.jsxs("div",{children:["  x = embedding(input_tokens) ",e.jsx("span",{className:"text-slate-500",children:"# [L, d]"})]})]}),e.jsx("br",{}),e.jsxs("div",{className:s===1.5?"bg-fuchsia-900/50 text-fuchsia-200 px-1 -mx-1 rounded":"text-slate-400",children:[e.jsxs("div",{children:["  ",e.jsx("span",{className:"text-slate-500",children:"# RoPE: 注入旋转位置编码 (让模型感知词序)"})]}),e.jsxs("div",{children:["  ",e.jsx("span",{className:"text-emerald-400",children:"for"})," m, seq_x ",e.jsx("span",{className:"text-emerald-400",children:"in"})," enumerate(x): ",e.jsx("span",{className:"text-slate-500",children:"# m 为绝对位置"})]}),e.jsx("div",{children:"      x[m] = apply_rotary_emb(seq_x, pos=m) "})]}),e.jsx("br",{}),e.jsxs("div",{className:s===4?"bg-amber-900/40 text-amber-200 px-1 -mx-1 rounded font-bold border-l-2 border-amber-400":"text-emerald-400",children:[e.jsx("span",{className:"text-emerald-400",children:"for"})," layer ",e.jsx("span",{className:"text-emerald-400",children:"in"})," ",e.jsx("span",{className:"text-blue-300",children:"range"}),"(",N,"): ",e.jsx("span",{className:"text-slate-500 font-normal",children:"# 层循环堆叠"})]}),e.jsxs("div",{className:s===2?"bg-blue-900/60 text-blue-200 px-1 -mx-1 rounded":"text-slate-400",children:[e.jsxs("div",{children:["      ",e.jsx("span",{className:"text-slate-500",children:"# 注意力与 KV Cache"})]}),e.jsx("div",{children:"      q, k, v = x@W_q, x@W_k, x@W_v"}),e.jsxs("div",{className:s===2&&t==="decode"?"text-pink-300 font-bold":"",children:["      ",t==="prefill"?"kv_cache.append(k, v)":"kv_cache.K = concat([kv_cache.K, k]); kv_cache.V = ..."]}),e.jsx("div",{children:"      scores = (q @ kv_cache.K.T) / sqrt(d)"}),e.jsx("div",{children:"      attn_out = softmax(scores) @ kv_cache.V"})]}),e.jsx("br",{}),n==="dense"?e.jsxs("div",{className:s===3?"bg-indigo-900/60 text-indigo-200 px-1 -mx-1 rounded":"text-slate-400",children:[e.jsxs("div",{children:["      ",e.jsx("span",{className:"text-slate-500",children:"# Dense FFN"})]}),e.jsx("div",{children:"      hidden = gelu(attn_out @ W_up)"}),e.jsxs("div",{children:["      x = x + (hidden @ W_down) ",e.jsx("span",{className:"text-slate-500",children:"# 残差连接并进入下一层"})]})]}):e.jsxs("div",{className:s===3?"bg-teal-900/50 text-teal-200 px-1 -mx-1 rounded":"text-slate-400",children:[e.jsxs("div",{children:["      ",e.jsx("span",{className:"text-slate-500",children:"# Sparse MoE: 路由分发"})]}),e.jsx("div",{className:s===3?"text-amber-200 font-bold":"",children:"      r_scores = softmax(attn_out @ W_gate) "}),e.jsx("div",{className:s===3?"text-amber-200":"",children:"      weights, experts = topk(r_scores, k=2)"}),e.jsx("div",{children:"      moe_out = zeros_like(attn_out)"}),e.jsxs("div",{children:["      ",e.jsx("span",{className:"text-emerald-400",children:"for"})," i ",e.jsx("span",{className:"text-emerald-400",children:"in"})," ",e.jsx("span",{className:"text-blue-300",children:"range"}),"(2):"]}),e.jsx("div",{children:"          e_idx = experts[i]; w = weights[i]"}),e.jsx("div",{children:"          e_out = gelu(attn_out @ W_up[e_idx]) @ W_down[e_idx]"}),e.jsx("div",{className:s===3?"text-amber-200":"",children:"          moe_out += w * e_out"}),e.jsxs("div",{children:["      x = x + moe_out ",e.jsx("span",{className:"text-slate-500",children:"# 残差连接"})]})]}),e.jsx("br",{}),e.jsxs("div",{className:s>=5?"bg-purple-900/60 text-purple-200 px-1 -mx-1 rounded":"text-slate-400",children:[e.jsxs("div",{children:["  ",e.jsx("span",{className:"text-slate-500",children:"# LM Head & 温度采样"})]}),e.jsxs("div",{children:["  logits = x[-1] @ W_vocab ",e.jsx("span",{className:"text-slate-500",children:"# 映射到词表"})]}),e.jsxs("div",{className:s>=5&&b!==1?"text-purple-300 font-bold":"",children:["  logits = logits / temp   ",e.jsx("span",{className:"text-slate-500",children:"# 温度调整缩放"})]}),e.jsx("div",{children:"  probs = softmax(logits)"}),e.jsxs("div",{children:["  ",e.jsx("span",{className:"text-emerald-400",children:"return"})," sample(probs)"]})]})]})})]})]})]}),e.jsxs("div",{className:"col-span-1 space-y-6",children:[e.jsxs("div",{className:"bg-white rounded-2xl p-6 shadow-sm border border-slate-200",children:[e.jsxs("h2",{className:"text-lg font-semibold mb-4 flex items-center gap-2",children:[e.jsx(se,{className:"text-indigo-500",size:20})," KV Cache (显存)"]}),e.jsxs("div",{className:"flex items-end gap-2 mb-2",children:[e.jsx("span",{className:"text-3xl font-bold text-indigo-600",children:M}),e.jsxs("span",{className:"text-slate-500 text-sm mb-1",children:["/ ",p.length+u.length-1," 槽位"]})]}),e.jsx("div",{className:"flex flex-wrap gap-1 mt-4",children:Array.from({length:p.length+u.length-1}).map((a,l)=>e.jsx("div",{className:`h-8 flex-1 rounded-sm transition-all duration-300 ${l<M?l<p.length?"bg-blue-400":"bg-green-400":"bg-slate-100"}`,title:l<M?`Cached Token ${l}`:"Empty Space"},l))})]}),e.jsxs("div",{className:"bg-indigo-900 text-indigo-50 rounded-2xl p-6 shadow-lg",children:[e.jsx("h3",{className:"text-lg font-bold mb-4 text-white",children:"当前微观执行状态"}),e.jsxs("div",{className:"space-y-4 text-sm leading-relaxed",children:[s===0&&e.jsxs("p",{className:"opacity-90",children:["等待开始。当前选择：",e.jsx("strong",{className:"text-amber-300",children:n==="moe"?"MoE 稀疏架构":"Dense 稠密架构"}),"。请点击“开始计算”。"]}),s===1&&e.jsxs("div",{className:"animate-fade-in",children:[e.jsx("h4",{className:"font-bold text-indigo-300 text-base mb-2",children:"Embedding 阶段"}),e.jsx("p",{className:"opacity-90",children:t==="prefill"?"并行读取整个 Prompt。":"【自回归现象】提取上轮生成的 Token 作为当前唯一输入。"})]}),s===1.5&&e.jsxs("div",{className:"animate-fade-in",children:[e.jsxs("h4",{className:"font-bold text-fuchsia-300 text-base mb-2 flex items-center gap-2",children:[e.jsx(A,{size:16})," RoPE 位置编码"]}),e.jsxs("p",{className:"opacity-90",children:["Transformer 本身是无视词序的。RoPE 通过将词向量当作复数平面的点，根据其所在的绝对位置 $m$，进行特定角度 $\\theta$ 的",e.jsx("strong",{children:"旋转变换"}),"。",e.jsx("br",{}),e.jsx("span",{className:"text-xs text-fuchsia-200 mt-1 block",children:"这样后续在算 Attention 向量点积时，模型就能自动感知词与词之间的相对距离！"})]})]}),s===2&&e.jsxs("div",{className:"animate-fade-in",children:[e.jsx("h4",{className:"font-bold text-blue-300 text-base mb-2",children:"Attention 机制与缓存"}),e.jsx("p",{className:"opacity-90",children:t==="prefill"?"将计算出的 K, V 并行写入显存池。":"【显存墙瓶颈】模型必须读取全部历史 KV Cache (粉色维度) 来计算当前的注意力分布。"})]}),s===3&&e.jsx("div",{className:"animate-fade-in",children:n==="dense"?e.jsxs(e.Fragment,{children:[e.jsx("h4",{className:"font-bold text-indigo-300 text-base mb-2",children:"Dense FFN"}),e.jsx("p",{className:"opacity-90",children:"全量激活巨大的矩阵网络提取知识特征。"})]}):e.jsxs(e.Fragment,{children:[e.jsxs("h4",{className:"font-bold text-teal-300 text-base mb-2 flex items-center gap-2",children:[e.jsx(C,{size:16})," MoE 稀疏路由"]}),e.jsxs("p",{className:"opacity-90",children:["Router 对 8 个专家进行打分，仅激活 ",e.jsx("strong",{className:"text-amber-300",children:"Top-2"})," 专家进行推理，最后加权融合。"]})]})}),s===4&&e.jsxs("div",{className:"animate-fade-in",children:[e.jsxs("h4",{className:"font-bold text-amber-300 text-base mb-2 flex items-center gap-2",children:[e.jsx(q,{size:16})," 深度循环堆叠 (N-Layers)"]}),e.jsxs("p",{className:"opacity-90",children:["大模型的“大”也体现在深度上。Attention 和 FFN 组成了一个 Block，数据不是走一遍就结束了，而是要通过残差连接，",e.jsxs("strong",{className:"text-white",children:["反复堆叠计算 ",N," 次"]})," 才能进入最后阶段！"]})]}),s>=5&&e.jsxs("div",{className:"animate-fade-in",children:[e.jsxs("h4",{className:"font-bold text-purple-300 text-base mb-2 flex items-center gap-2",children:[e.jsx(D,{size:16})," LM Head & 温度采样"]}),e.jsxs("ul",{className:"list-disc pl-4 space-y-2 opacity-90",children:[e.jsx("li",{children:"特征被映射为涵盖整个词表的 Logits (得分)。"}),e.jsxs("li",{children:[e.jsx("strong",{className:"text-amber-300",children:"温度(T)缩放："}),"你可以拖动上方滑块试试！",e.jsx("br",{}),"`T < 1`: 放大概率差异，强制模型输出最可能的词（适合写代码）。",e.jsx("br",{}),"`T > 1`: 缩小概率差异，长尾词也能被抽中（适合发散创作）。"]})]})]}),s===6&&e.jsxs("div",{className:"animate-fade-in text-center py-4 border-t border-indigo-700 mt-4 pt-4",children:[e.jsx("div",{className:"inline-block p-2 bg-emerald-800 rounded-full mb-2",children:e.jsx(T,{className:"text-emerald-400",size:20})}),e.jsx("h4",{className:"font-bold text-emerald-300 text-base",children:"Token 生成完毕"}),e.jsx("p",{className:"opacity-80 mt-1 text-xs",children:"通过采样掷骰子选中下一个词，准备丢回起点循环。"})]})]})]})]})]})]})})};export{ie as default};
